// pipeline {
//     agent any

//     environment {
//         SONARQUBE = 'sonarqube'   // Must match the SonarQube server name in Jenkins
//         IMAGE_NAME = 'node-app'
//         IMAGE_TAG = "v${env.BUILD_NUMBER}"
//         NEXUS_REPO = 'nexus:8082'
//     }

//     stages {
//         stages {
//     stage('Checkout') {
//       steps {
//         git url: 'https://github.com/pre3thi19/ci-cd-project.git', branch: 'main' // Replace accordingly
//       }
//     }

//         stage('Install') {
//             steps {
//                 sh 'npm install'
//             }
//         }

//         stage('SonarQube Analysis') {
//             steps {
//                 withSonarQubeEnv("${SONARQUBE}") {
//                     withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
//                         sh 'sonar-scanner -Dsonar.login=$SONAR_TOKEN'
//                     }
//                 }
//             }
//         }

//         stage('Docker Build') {
//             steps {
//                 sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
//             }
//         }

//         stage('Security Scan - Trivy') {
//             steps {
//                 sh "trivy image --exit-code 1 --severity HIGH,CRITICAL ${IMAGE_NAME}:${IMAGE_TAG}"
//             }
//         }

//         stage('Push to Nexus') {
//             steps {
//                 script {
//                     sh '''
//                         docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${NEXUS_REPO}/${IMAGE_NAME}:${IMAGE_TAG}
//                         echo 'admin:admin123' | docker login ${NEXUS_REPO} --username admin --password-stdin
//                         docker push ${NEXUS_REPO}/${IMAGE_NAME}:${IMAGE_TAG}
//                     '''
//                 }
//             }
//         }
//     }
// }

pipeline {
  agent {
    docker {
      image 'node:18' // Change to a custom image later if needed
    }
  }

  environment {
    SONARQUBE = 'sonarqube'             // Match Jenkins global config name
    SONAR_TOKEN = credentials('sonar-token')  // Jenkins Credentials ID
  }

  tools {
    sonarQubeScanner 'SonarScanner'     // Must match Global Tool name in Jenkins
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/pre3thi19/ci-cd-project.git', branch: 'main'
      }
    }

    stage('Install Dependencies') {
      steps {
        sh 'npm install'
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv("${SONARQUBE}") {
          sh """
            sonar-scanner \
              -Dsonar.projectKey=node-app \
              -Dsonar.projectName='Node App' \
              -Dsonar.sources=. \
              -Dsonar.exclusions=node_modules/**,Dockerfile,Jenkinsfile \
              -Dsonar.login=$SONAR_TOKEN
          """
        }
      }
    }
  }
}
